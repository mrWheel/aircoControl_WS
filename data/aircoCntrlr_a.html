<!DOCTYPE html>
<!--
//*************************************************************************  
//  Program  : index.html, part of aircoControl
//  Version  : v0.1.0 (WebSockets)
//
//  Copyright (c) 2019 Willem Aandewiel
//
//  TERMS OF USE: MIT License. See bottom of file.                                                            
//*************************************************************************
-->
<html charset="UTF-8">
  <head>
  <style>
fieldset {
  position: relative;
}

.tabButton { 
	width: 100px; 
	height: 30px;
	font-size: 15pt;
  text-align: center;
	background: #d6d4d3;
}

.tabName div {
    background-color: lightblue;
}

.buttonRow {
		background-color: #ffffff; 
		margin: 10px 5px 15px 20px; 
		border-color: #ffffff;
}

.profile {
	border-style: solid;
  border-width: 1px;
}

.profile p {
    overflow: hidden;
    background-color: lightblue;
}
.profile .label {
    vertical-align: top;
    float: left;
    width: 150px;
    padding-right: 24px;
}

.profile .value{
    vertical-align: top;
    float: left;
    width: 140px; 
/*  width: calc(90% - 150px); */
}

#logWindow {
		font-size: 14px;
		margin-left: 20px;
		width: 90vw;
    height: 20vh;
}

.dev-header h1 { 
  display: inline;
}
    
.footer {
   position: fixed;
   left: 0;
   bottom: 0;
   width: 100%;
   color: gray;
   font-size: small;
   text-align: right;
}
/* define tag selectors (.) ------------------------------------------------- */

body {  margin: 10; }
button { width: 90px; }

/* End Style ---------------------------------------------------------------- */
</style>  
  
    <meta name="viewport" content="width=device-width, initial-scale=1">	
<!--    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    
    <title>Airco Controller (v0.1.0) [WebSockets]</title>
  </head>
  <body>
	<font face="Arial">
		<div class="dev-header">
        <h1><span id="devName" style='vertical-align:center;'>aircoControl</span> &nbsp; &nbsp; &nbsp; </h1>
        <span id="devVersion" style='vertical-align:center;'>[version]</span>
    </div>
  </font>

  <div style="background:#d6d4d3;">
  	<button id="bControl" class="tabButton" style="background:#ffffff;" onclick="openTab('Control')">Control</button>
  	<button id="bGrafiek" class="tabButton" onclick="openTab('Grafiek')">Grafiek</button>
  	<button id="bHistorie" class="tabButton" onclick="openTab('Historie')">Historie</button>
  </div>
  <hr>

  <div id="Control" class="tabName">	<!-- Start Control Tab -->
  	<div id="controlTab" class="dummy">
  		<div class="profile">
  			<p>
        	<span class="label">Date/Time</span>
        	<span id="aircoTime" class="value">00:00</span>
        </p>
        <p>
        	<span class="label">Temp. (intern)</span>
        	<span id="inTemp1" class="value">0</span>
        </p>
        <p>
        	<span class="label">Temp. (buiten)</span>
        	<span id="outTemp" class="value">0</span>
        </p>
        <p>
        	<span class="label">upTime</span>
          <span id="upTime" class="value">00:00:00</span>
        </p>
        <p>
          <span class="label">Airco Status</span>
          <span id="aircoStatus" class="value">unKnown</span>
        </p>
      </div>


      <div class="buttonRow">
      	  <button id="buttonOff"  onclick="handleButton('Off')">Uit</button>
          <button id="buttonCool" onclick="handleButton('Koelen')">Koelen</button>
          <button id="buttonHeat" onclick="handleButton('Verwarmen')">Verwarmen</button>
      	<br></br>
      </div>
  	
  		<div class="profile">
  			<p>
		  		<span class="label">Airco Cool Treshold</span>
		  		<span id="aircoCoolTemp" class="value">-</span>
        </p>
        <p>
  				<span class="label">Airco Heat Treshold</span>
  				<span id="aircoHeatTemp" class="value">-</span>
        </p>
        <p>
  				<span class="label">Number of dataPoints</span>
  				<span id="aircoDataPoints" class="value">-</span> 
        </p>
        <p>
  				<span class="label">Next Poll</span>
  				<span id="aircoNextPoll" class="value">-</span>
        </p>
        <p>
  				<span class="label">Next Plot</span>
  				<span id="aircoNextPlot" class="value">-</span>
        </p>
      </div>
    </div>	<!-- outer div -->
  </div>	<!-- Einde Control Tab -->

  <div id="Grafiek" class="tabName" style="display:none">
  	<h2>Grafiek</h2>
  	<canvas id="chartTemp">Grafiek afgelopen periode</canvas> 
  </div>

  <div id="Historie" class="tabName" style="display:none">
  	<h2>Historie</h2>
  	<p>Historie afgelopen periode</p>
  </div>
  
  <div id="Redirect"></div>
	<textarea id="logWindow"></textarea>


  <script>
"use strict";

	let webSocketConn;
  let validJson = false;
  let jsonMessage;   
  let singlePair;

  window.onload=bootsTrap;

 	function openTab(tabName) {
 		let bID = "b" + tabName;
    document.getElementById("bControl").style.background='#d6d4d3';
    document.getElementById("bGrafiek").style.background='#d6d4d3';
    document.getElementById("bHistorie").style.background='#d6d4d3';
 		let i;
 		let x = document.getElementsByClassName("tabName");
 		for (i = 0; i < x.length; i++) {
 			x[i].style.display = "none";  
 		}
    document.getElementById(bID).style.background='#ffffff';
 		document.getElementById(tabName).style.display = "block";  
    if (tabName == "Control") {
 			addLogLine("newTab: Control");
 			webSocketConn.send("tabControl");
 			
 		} else if (tabName == "Grafiek") {
 			addLogLine("newTab: Grafiek");
 			webSocketConn.send("tabGrafiek");
 			//webSocketConn.send("getHistory");

 		} else if (tabName == "Historie") {
 			addLogLine("newTab: Historie");
 			webSocketConn.send("tabHistorie");

 		}
 	}	// openTab()
  	
  
  function bootsTrap() {
		addLogLine("bootsTrap()");

		document.getElementById('logWindow').style.display = "block";
    
    let count = 0;
    while (document.getElementById('devVersion').value == "[version]") {
    	count++;
    	addLogLine("count ["+count+"] devVersion is ["+document.getElementById('devVersion').value+"]");
    	if (count > 10) {
    		alert("Count="+count+" => reload from server!");
    		window.location.reload(true);
    	}
    	setTimeout("", 500);
    }

  } // bootsTrap()
  
  webSocketConn	= new WebSocket('ws://'+location.host+':81/', ['arduino']);
  addLogLine(" ");
  addLogLine("WebSocket('ws://"+location.host+":81/', ['arduino'])");
  
  webSocketConn.onopen 		= function () { 
  	addLogLine("Connected!");
   	webSocketConn.send('Connect ' + new Date()); 
   	addLogLine("getDevInfo");
   	webSocketConn.send("getDevInfo");
		addLogLine("initTab: Control");
		webSocketConn.send("tabControl");

  }; 
  webSocketConn.onclose 		= function () { 
   	addLogLine(" ");
   	addLogLine("Disconnected!");
   	addLogLine(" ");
   	openTab('Control')
   	let redirectButton = "<p></p><hr><p></p><p></p>"; 
   	redirectButton    += "<style='font-size: 50px;'>Disconneted from aircoController"; 
   	redirectButton    += "<input type='submit' value='re-Connect' "; 
    redirectButton    += " onclick='window.location=\"/\";' />  ";     
   	redirectButton    += "<p></p><p></p><hr><p></p>"; 
		document.getElementById("Control").innerHTML = redirectButton;

  }; 
  webSocketConn.onerror 	= function (error) 	{ 
   	addLogLine("Error: " + error);
   	console.log('WebSocket Error ', error);
  };
  webSocketConn.onmessage	= function (e) {
   	addLogLine("onmessage: " + e.data);
    parsePayload(e.data); 
  };

  function addLogLine(text) {
  	let logWindow = document.getElementById("logWindow");
  	let myTime = new Date().toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1");
  	let addText = document.createTextNode("["+myTime+"] "+text+"\r\n");
  	logWindow.appendChild(addText);
  	document.getElementById("logWindow").scrollTop = document.getElementById("logWindow").scrollHeight 

  }	// add LogLine()
		
	function parsePayload(payload) {
  	validJson = IsJsonString(payload);
  	if ( payload.startsWith('aircoStatus') ) {											// not json!
  		addLogLine("parsePayload(Status): received [" + payload + "]");
  		singlePair   = payload.split(",");
  		document.getElementById("buttonCool").style.background 		='#ffffff';
  		document.getElementById("buttonCool").style.fontWeight 		= "400";
  		document.getElementById("buttonHeat").style.background 		='#ffffff';
  		document.getElementById("buttonHeat").style.fontWeight 		= "400";
  		document.getElementById("buttonOff").style.background  		='#ffffff';
  		document.getElementById("buttonOff").style.fontWeight  		= "400";
     	if ( singlePair[1] == 1 ) {
       	document.getElementById('aircoStatus').innerHTML 			 	= "COOL";
       	document.getElementById("buttonCool").style.background 	= '#4583ff';
       	document.getElementById("buttonCool").style.fontWeight  = "900";
      } else if ( singlePair[1] == 2 ) {
       	document.getElementById('aircoStatus').innerHTML 				= "HEAT";
       	document.getElementById("buttonHeat").style.background 	= '#42ff35';
       	document.getElementById("buttonHeat").style.fontWeight 	= "900";
      } else {
       	document.getElementById('aircoStatus').innerHTML 				= "OFF";
       	document.getElementById("buttonOff").style.background  	= 'lightgray';
       	document.getElementById("buttonOff").style.fontWeight 	= "900";
      }


  	} else if (    payload.startsWith('inTemp1') 
  						 ||  payload.startsWith('outTemp') 
  						 ||  payload.startsWith('aircoCoolTemp') 
  						 ||  payload.startsWith('aircoHeatTemp') 
  																											) {					// not json!
  			addLogLine("parsePayload(temps): received [" + payload + "]");
  			singlePair   = payload.split(",");
  			document.getElementById(singlePair[0]).innerHTML = singlePair[1] + "&deg;C";

  	} else if (     payload.startsWith('upTime') 
  							||  payload.startsWith('aircoTime')
  							||  payload.startsWith('aircoDataPoints') 
  							||  payload.startsWith('aircoNextPoll') 
  							||  payload.startsWith('aircoNextPlot') 
  																											) {					// not json!
  			addLogLine("parsePayload(data): received [" + payload + "]");
  			singlePair   = payload.split(",");
  			document.getElementById(singlePair[0]).innerHTML = singlePair[1];
		
  	} else if ( payload.startsWith('Switch') ) {										// not json!
  			addLogLine("parsePayload(Switch): received [" + payload + "]");
  			singlePair   = payload.split(",");
  			document.getElementById(singlePair[0]).innerHTML = singlePair[1];
		
  	} else if (validJson) {
  		jsonMessage = JSON.parse(payload);
  		addLogLine("parsePayload(json): [" + jsonMessage.msgType + "]");
  		console.log("parsePayload(json): [" + jsonMessage.msgType + "]");
    	if ((jsonMessage.msgType == "devInfo")) {
      	document.getElementById("devName").innerHTML    = jsonMessage.devName;
      	document.getElementById("devVersion").innerHTML = jsonMessage.devVersion;
      	addLogLine("parsePayload(): "+jsonMessage.devIPaddress);
      	
//    } else if (jsonMessage.msgType == "sendStatus") {
//     	updateAircoState(payload);
      	
      } else if (jsonMessage.msgType == "sendHistory1") {
      	drawChart(payload);

      }
  	} else {
 			addLogLine("parsePayload(): Don't know: [" + payload + "]\r\n");
  	}
  };
  
  function IsJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
  }	// IsJsonString()

      
  function drawChart(json){
  	var labels  = [];
    var tempIn  = [];
    var tempOut = []; 

//    $.getJSON('/graph_temp.json', function(json) {
			let obj = JSON.parse(json);
    		for ( var i = 0; i < obj.timestamp.length; i++ ) {
    			let d = new Date(obj.timestamp[i] * 1000);
          labels.push( d );
         	tempIn.push( obj.inTemp1[i] );
         	tempOut.push( obj.outTemp[i] ); 
        };	// for ..

        // Get the context of the canvas element we want to select
        let ctx = document.getElementById("chartTemp").getContext("2d");
        ctx.canvas.width = 400;
        ctx.canvas.height = 100;
                
        // Instantiate a new chart using 'data' (defined below)
        let chartTemp = new Chart(ctx, {
        		type: 'line',
            data: {
            	labels: labels,
            	datasets: [{
            		label: "Binnen",
            		data: tempIn,
            		borderWidth: 2,
            		//backgroundColor: "rgba(6, 167, 125, 0.1)",
            		borderColor: "rgba(6, 167, 125, 1)",
            		//pointBackgroundColor: "rgba(225, 225, 225, 1)",
            		//pointBorderColor: "rgba(6, 167, 125, 1)",
            		//pointHoverBackgroundColor: "rgba(6, 167, 125, 1)",
            		//pointHoverBorderColor: "#fff",
            		fill: false
            	}, {
            		label: "Buiten",
            		data: tempOut,
            		borderWidth: 2,
            		//backgroundColor: "rgba(246, 71, 64, 0.1)",
            		borderColor: "rgba(246, 71, 64, 1)",
            		//pointBackgroundColor: "rgba(225, 225, 225, 1)",
            		//pointBorderColor: "rgba(246, 71, 64, 1)",
            		//pointHoverBackgroundColor: "rgba(246, 71, 64, 1)",
            		//pointHoverBorderColor: "#fff",
            		fill: false
            	}]
            },
            options: {
            	scales: {
           			xAxes: [{
           				type: 'time',
           				time: {
           					unit: 'hour',
           					unitStepSize: 2,                					
           					displayFormats: {
           						hour: '(DD) HH:mm'
           					}
           				}
//           			}],
//          		yAxes : [{
//           			ticks : {
//           				suggestedMin: 10,
//           		  	//beginAtZero : false
//           			}   
           			}]          
            	}	// scales ..
           	}	// options ..
        });	// charTemp ..
//  });	// getJson()
  };// drawChart()
  
  function handleButton(buttonPressed) {
  	if (buttonPressed == 'Koelen') {
 			addLogLine("buttonPressed(Koelen)");
 			webSocketConn.send("Button: COOL");

  	} else if (buttonPressed == 'Verwarmen') {
 			addLogLine("buttonPressed(Verwarmen)");
 			webSocketConn.send("Button: HEAT");

  	} else {
 			addLogLine("buttonPressed(Off)");
 			webSocketConn.send("Button: OFF");

  	}
  }	// handleButton()
/**
      // AircoControl change
      $('#Airco_Off').click(function(){  setAirco('aircoStatus', '0'); });
      $('#Airco_Cool').click(function(){ setAirco('aircoStatus', '1'); });
      $('#Airco_Heat').click(function(){ setAirco('aircoStatus', '2'); });
        
      function setAirco(id, status){
        $.post("setAirco?id=" + id + "&aircoStatus=" + status).done(function(data){
          console.log("Retour setAirco " + JSON.stringify(data)); 
          var id_aircoStatus = "#aircoStatus";
          console.log(data);
          if ( data.success === "1" | data.success === 1 ) {
            if ( data.aircoStatus === "1" ) {
              $(id_aircoStatus).html("COOL");
            } else if ( data.aircoStatus === "2" ) {
              $(id_aircoStatus).html("HEAT");
            } else {
              $(id_aircoStatus).html("OFF");
            }  
          } else {
            $(id_aircoStatus).html('UnKnown');
          }      
        }).fail(function(err){
          console.log("err setAirco " + JSON.stringify(err));
        });
      } 
***/
      
      function updateAircoState(json) {
      	let obj = JSON.parse(json);

        // only if chart panel is active
          	console.log("updateAircoState : " + JSON.stringify(obj) + "|" + obj.aircoTime);
          	addLogLine("updateAircoState : " + JSON.stringify(obj) + "|" + obj.aircoTime);
          //document.getElementById('aircoTime').innerHTML = obj.aircoTime;
          //document.getElementById('aircoInTemp1').innerHTML = obj.aircoInTemp1 + "&deg;C";
          //document.getElementById('aircoOutTemp').innerHTML = obj.aircoOutTemp + "&deg;C";
          //document.getElementById('upTime').innerHTML = obj.upTime;
          //document.getElementById('aircoCoolTemp').innerHTML = obj.aircoCoolTemp + "&deg;C";
          //document.getElementById('aircoHeatTemp').innerHTML = obj.aircoHeatTemp + "&deg;C";
          //document.getElementById('aircoDataPoints').innerHTML = obj.aircoDataPoints;
          //document.getElementById('aircoNextPoll').innerHTML = obj.aircoNextPoll;
          //document.getElementById('aircoNextPlot').innerHTML = obj.aircoNextPlot;

      };	// updateAircoState()


  </script>

  </body>
  	<div class="footer">
      <hr>
  		2019 &copy; Willem Aandewiel &nbsp; &nbsp;
  	</div>
</html>

<!--
//***************************************************************************
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT
// OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
// THE USE OR OTHER DEALINGS IN THE SOFTWARE.
// 
//***************************************************************************
-->